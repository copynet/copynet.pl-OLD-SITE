/*
 * Jeditable - jQuery in place edit plugin
 *
 * Copyright (c) 2006-2009 Mika Tuupola, Dylan Verheul
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Project home:
 *   http://www.appelsiini.net/projects/jeditable
 *
 * Based on editable by Dylan Verheul <dylan_at_dyve.net>:
 *    http://www.dyve.net/jquery/?editable
 *
 */
(function(a){a.fn.editable=function(o,u){if('disable'==o){a(this).data('disabled.editable',true);return}if('enable'==o){a(this).data('disabled.editable',false);return}if('destroy'==o){a(this).unbind(a(this).data('event.editable')).removeData('disabled.editable').removeData('event.editable');return}var b=a.extend({},a.fn.editable.defaults,{target:o},u);var v=a.editable.types[b.type].plugin||function(){};var w=a.editable.types[b.type].submit||function(){};var x=a.editable.types[b.type].buttons||a.editable.types['defaults'].buttons;var r=a.editable.types[b.type].content||a.editable.types['defaults'].content;var y=a.editable.types[b.type].element||a.editable.types['defaults'].element;var q=a.editable.types[b.type].reset||a.editable.types['defaults'].reset;var s=b.callback||function(){};var z=b.onedit||function(){};var A=b.onsubmit||function(){};var B=b.onreset||function(){};var C=b.onerror||q;if(b.tooltip){a(this).attr('title',b.tooltip)}b.autowidth='auto'==b.width;b.autoheight='auto'==b.height;return this.each(function(){var c=this;var D=a(c).width();var E=a(c).height();a(this).data('event.editable',b.event);if(!a.trim(a(this).html())){a(this).html(b.placeholder)}a(this).bind(b.event,function(t){if(true===a(this).data('disabled.editable')){return}if(c.editing){return}if(false===z.apply(this,[b,c])){return}t.preventDefault();t.stopPropagation();if(b.tooltip){a(c).removeAttr('title')}if(0==a(c).width()){b.width=D;b.height=E}else{if(b.width!='none'){b.width=b.autowidth?a(c).width():b.width}if(b.height!='none'){b.height=b.autoheight?a(c).height():b.height}}if(a(this).html().toLowerCase().replace(/(;|")/g,'')==b.placeholder.toLowerCase().replace(/(;|")/g,'')){a(this).html('')}c.editing=true;c.revert=a(c).html();a(c).html('');var f=a('<form />');if(b.cssclass){if('inherit'==b.cssclass){f.attr('class',a(c).attr('class'))}else{f.attr('class',b.cssclass)}}if(b.style){if('inherit'==b.style){f.attr('style',a(c).attr('style'));f.css('display',a(c).css('display'))}else{f.attr('style',b.style)}}var h=y.apply(f,[b,c]);var n;if(b.loadurl){var l=setTimeout(function(){h.disabled=true;r.apply(f,[b.loadtext,b,c])},100);var p={};p[b.id]=c.id;if(a.isFunction(b.loaddata)){a.extend(p,b.loaddata.apply(c,[c.revert,b]))}else{a.extend(p,b.loaddata)}a.ajax({type:b.loadtype,url:b.loadurl,data:p,async:false,success:function(d){window.clearTimeout(l);n=d;h.disabled=false}})}else if(b.data){n=b.data;if(a.isFunction(b.data)){n=b.data.apply(c,[c.revert,b])}}else{n=c.revert}r.apply(f,[n,b,c]);h.attr('name',b.name);x.apply(f,[b,c]);a(c).append(f);v.apply(f,[b,c]);a(':input:visible:enabled:first',f).focus();if(b.select){h.select()}h.keydown(function(d){if(d.keyCode==27){d.preventDefault();q.apply(f,[b,c])}});var l;if('cancel'==b.onblur){h.blur(function(d){l=setTimeout(function(){q.apply(f,[b,c])},500)})}else if('submit'==b.onblur){h.blur(function(d){l=setTimeout(function(){f.submit()},200)})}else if(a.isFunction(b.onblur)){h.blur(function(d){b.onblur.apply(c,[h.val(),b])})}else{h.blur(function(d){})}f.submit(function(j){if(l){clearTimeout(l)}j.preventDefault();if(false!==A.apply(f,[b,c])){if(false!==w.apply(f,[b,c])){if(a.isFunction(b.target)){var m=b.target.apply(c,[h.val(),b]);a(c).html(m);c.editing=false;s.apply(c,[c.innerHTML,b]);if(!a.trim(a(c).html())){a(c).html(b.placeholder)}}else{var i={};i[b.name]=h.val();i[b.id]=c.id;if(a.isFunction(b.submitdata)){a.extend(i,b.submitdata.apply(c,[c.revert,b]))}else{a.extend(i,b.submitdata)}if('PUT'==b.method){i['_method']='put'}a(c).html(b.indicator);var k={type:'POST',data:i,dataType:'html',url:b.target,success:function(d,g){if(k.dataType=='html'){a(c).html(d)}c.editing=false;s.apply(c,[d,b]);if(!a.trim(a(c).html())){a(c).html(b.placeholder)}},error:function(d,g,e){C.apply(f,[b,c,d])}};a.extend(k,b.ajaxoptions);a.ajax(k)}}}a(c).attr('title',b.tooltip);return false})});this.reset=function(d){if(this.editing){if(false!==B.apply(d,[b,c])){a(c).html(c.revert);c.editing=false;if(!a.trim(a(c).html())){a(c).html(b.placeholder)}if(b.tooltip){a(c).attr('title',b.tooltip)}}}}})};a.editable={types:{defaults:{element:function(d,g){var e=a('<input type="hidden"></input>');a(this).append(e);return(e)},content:function(d,g,e){a(':input:first',this).val(d)},reset:function(d,g){g.reset(this)},buttons:function(e,j){var m=this;if(e.submit){if(e.submit.match(/>$/)){var i=a(e.submit).click(function(){if(i.attr("type")!="submit"){m.submit()}})}else{var i=a('<button type="submit" />');i.html(e.submit)}a(this).append(i)}if(e.cancel){if(e.cancel.match(/>$/)){var k=a(e.cancel)}else{var k=a('<button type="cancel" />');k.html(e.cancel)}a(this).append(k);a(k).click(function(d){if(a.isFunction(a.editable.types[e.type].reset)){var g=a.editable.types[e.type].reset}else{var g=a.editable.types['defaults'].reset}g.apply(m,[e,j]);return false})}}},text:{element:function(d,g){var e=a('<input />');if(d.width!='none'){e.width(d.width)}if(d.height!='none'){e.height(d.height)}e.attr('autocomplete','off');a(this).append(e);return(e)}},textarea:{element:function(d,g){var e=a('<textarea />');if(d.rows){e.attr('rows',d.rows)}else if(d.height!="none"){e.height(d.height)}if(d.cols){e.attr('cols',d.cols)}else if(d.width!="none"){e.width(d.width)}a(this).append(e);return(e)}},select:{element:function(d,g){var e=a('<select />');a(this).append(e);return(e)},content:function(d,g,e){if(String==d.constructor){eval('var json = '+d)}else{var j=d}for(var key in j){if(!j.hasOwnProperty(key)){continue}if('selected'==key){continue}var m=a('<option />').val(key).append(j[key]);a('select',this).append(m)}a('select',this).children().each(function(){if(a(this).val()==j['selected']||a(this).text()==a.trim(e.revert)){a(this).attr('selected','selected')}})}}},addInputType:function(d,g){a.editable.types[d]=g}};a.fn.editable.defaults={name:'value',id:'id',type:'text',width:'auto',height:'auto',event:'click.editable',onblur:'cancel',loadtype:'GET',loadtext:'Loading...',placeholder:'Click to edit',loaddata:{},submitdata:{},ajaxoptions:{}}})(jQuery);